<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wapod Console</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 5px;
        }

        .page {
            max-width: 900px;
            margin: auto;
            padding: 5px;
            padding-bottom: 150px;
            /* Add bottom padding to account for floating log box */
        }

        .tabs {
            overflow: hidden;
            background-color: #f1f1f1;
        }

        .tab {
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        .tab:hover {
            background-color: #ddd;
        }

        .tab.active {
            background-color: #ccc;
        }

        .tabcontent {
            padding: 6px 12px;
            border-top: none;
        }

        .collapsible {
            background-color: #777;
            color: white;
            cursor: pointer;
            padding: 10px;
            /* Reduced padding */
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 14px;
            /* Reduced font-size */
        }

        .active,
        .collapsible:hover {
            background-color: #555;
        }

        .content {
            padding: 0 10px;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f1f1f1;
            margin-bottom: 5px;
            /* Reduced margin */
        }

        .form-group {
            margin-bottom: 5px;
            /* Reduced margin */
        }

        label {
            display: block;
            margin-bottom: 2px;
            /* Reduced margin */
        }

        input[type="text"],
        input[type="file"],
        input[type="number"],
        button,
        textarea,
        table {
            width: 100%;
            padding: 6px;
            /* Reduced padding */
            margin-top: 3px;
            /* Reduced margin */
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            margin-top: 0;
            /* Align with text baseline */
        }

        #workerInfo {
            height: 150px;
            margin-top: 10px;
            border: 1px solid #eee;
            background-color: #f2f2f2;
        }

        table {
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
            /* Reduced font-size */
        }

        th,
        td {
            border-bottom: 1px solid #dddddd;
            text-align: left;
            padding: 6px;
            /* Reduced padding */
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        button,
        input[type="checkbox"],
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            margin: 5px 5px 5px 0;
            /* Spacing around button for a tight layout */
            display: inline-block;
            /* Display buttons inline */
            vertical-align: middle;
            /* Align buttons middle to the line */
        }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group label {
            margin-right: 10px;
            white-space: nowrap;
            /* Prevent the label from wrapping */
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group input[type="number"],
        .form-group textarea {
            flex-grow: 1;
            /* Let input fields take the available space */
        }

        .shortened-address {
            max-width: 120px;
            /* Adjust the width to your preference */
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .app-op-buttons {
            max-width: 180px;
        }

        #consoleOutput {
            height: 130px;
            margin-top: 10px;
            /* Preserve formatting and spaces */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;

            border: 1px solid #333;
            /* Dark border color */
            background-color: #1e1e1e;
            /* Dark background */
            color: #dcdcdc;
            /* Light text color for contrast */
            font-family: 'Courier New', monospace;
            /* Monospace font for terminal look */
            font-size: 0.8em;
            /* Adjust font size if desired */
            padding: 6px;
            overflow-y: auto;
            /* Add a vertical scrollbar */
            white-space: pre;
        }

        .console-controls {
            /* Fixed position so it scrolls with the textarea */
            position: fixed;
            /* Place above the console box */
            bottom: 125px;
            /* Distance from the right side */
            right: 15px;
            /* Ensure it's above the logs */
            z-index: 1010;
        }

        .console-controls button {
            /* Smaller padding for tiny buttons */
            padding: 1px 1px;
            /* Smaller font size for tiny buttons */
            font-size: 0.7em;
            /* Space between buttons */
            margin-left: 0px;
        }

        /* Add to your style tag */
        #toasts {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 500;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            min-width: 250px;
            text-align: center;
            transition: all .5s;
            opacity: .9;
        }

        .toast.success {
            background-color: green;
        }

        .toast.error {
            background-color: red;
        }
    </style>
</head>

<body>
    <div id="app" class="page">
        <div id="toasts">
            <div v-for="(toast, index) in toasts" :key="index" :class="['toast', toast.type]">
                {{ toast.message }}
            </div>
        </div>

        <div class="tabs form-group">
            <button class="tab" @click="activeTab = 'workerInfo'">Worker Info</button>
            <button class="tab" @click="activeTab = 'blobs'">Blobs</button>
            <button class="tab" @click="activeTab = 'apps'">Apps</button>
        </div>

        <div v-show="activeTab === 'workerInfo'" class="tabcontent">
            <textarea id="workerInfo" v-model="workerInfoResponse"></textarea>
            <div class="form-group">
                <button @click="updateInfo">Refresh</button>
                <button @click="initWorker">Init Worker</button>
            </div>
        </div>

        <div v-show="activeTab === 'blobs'" class="tabcontent">
            <form @submit.prevent="uploadBlob">
                <div class="form-group">
                    <label for="putFile">File:</label>
                    <input type="file" id="putFile" ref="fileInput" name="file">
                    <button type="submit">Upload Blob</button>
                </div>
            </form>
        </div>

        <div v-show="activeTab === 'apps'" class="tabcontent">
            <div>
                <button type="button" @click="showDeployApp = !showDeployApp" class="collapsible">Deploy App</button>
                <div v-show="showDeployApp" class="content">
                    <form @submit.prevent="deployApp">
                        <div class="form-group">
                            <label for="deployCodeHash">Code Hash:</label>
                            <input type="text" v-model="deployForm.codeHash" required>
                        </div>
                        <div class="form-group">
                            <label for="deployArgs">Args:</label>
                            <input type="text" v-model="deployForm.args">
                        </div>
                        <div class="form-group">
                            <label for="deployEnvVars">Env Vars (list of string pairs):</label>
                            <textarea v-model="deployForm.envVars"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="deployStartMode">Start Mode:</label>
                            <input type="number" v-model.number="deployForm.startMode">
                        </div>
                        <div class="form-group">
                            <label for="deploySalt">Salt:</label>
                            <input type="text" v-model="deployForm.salt">
                        </div>
                        <div class="form-group">
                            <label for="deployResizable">Resizable:</label>
                            <input type="checkbox" v-model="deployForm.resizable">
                        </div>
                        <button type="submit">Deploy</button>
                    </form>
                </div>
            </div>

            <div id="deployedApps">
                <h2>Apps</h2>
                <div class="form-group">
                    <button @click="loadApps">Refresh</button>
                    <button @click="clearApps">Clear Apps</button>
                </div>
                <table id="appsTable">
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Address</th>
                            <th>Resizable</th>
                            <th>Start Mode</th>
                            <th>Instances</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="app in appsData" :key="app.address">
                            <td>{{ app.sn }}</td>
                            <td><span class="shortened-address">{{ app.address }}</span></td>
                            <td>{{ app.resizable ? 'Yes' : 'No' }}</td>
                            <td>{{ app.start_mode == 0 ? 'Imediate' : 'OnDemand' }}</td>
                            <td>{{ app.instances }}</td>
                            <td>
                                <div class="form-group app-op-buttons">
                                    <button class="btn-small" @click="stopApp(app.address)">Stop</button>
                                    <button class="btn-small" @click="startApp(app.address)">Start</button>
                                    <button class="btn-small" @click="resizeApp(app.address)">Resize</button>
                                    <button class="btn-small" @click="removeApp(app.address)">Remove</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="console-controls">
            <div class="form-group">
                <button @click="copyConsoleOutput">Copy</button>
                <button @click="clearConsoleOutput">Clear</button>
            </div>
        </div>
        <textarea id="consoleOutput" v-model="consoleOutput"></textarea>
    </div>

    <script src="https://unpkg.com/vue@3.4.27"></script>
    <script>
        Vue.createApp({
            data() {
                return {
                    showDeployApp: false,
                    activeTab: 'workerInfo',
                    workerInfoResponse: '',
                    consoleOutput: '',
                    appsData: [],
                    deployForm: {
                        codeHash: '',
                        args: '[]',
                        envVars: '[]',
                        startMode: 0,
                        salt: '0x00',
                        resizable: false
                    },
                    toasts: [],
                    nextToastId: 0,
                };
            },
            methods: {
                async fetchAPI(method, data) {
                    const toastId = this.addToast(`Calling ${method}`);
                    try {
                        data = data || {};
                        const response = await fetch(`/prpc/${method}?json`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        const success = response.ok;
                        this.updateToast(toastId, success);
                        return response.json();
                    } catch (err) {
                        this.updateToast(toastId, false);
                    }
                },

                async rpcCall(method, data) {
                    const response = await this.fetchAPI(method, data);
                    this.consoleLog(method, response);
                    return response;
                },

                toggleCollapsible(section) {
                    this.collapsibleStates[section] = !this.collapsibleStates[section];
                },

                async updateInfo() {
                    const data = await this.fetchAPI('Status.Info');
                    this.workerInfoResponse = JSON.stringify(data, null, 2);
                },

                async initWorker() {
                    await this.rpcCall('Worker.Init', { salt: "0x" });
                    await this.updateInfo();
                },

                async loadApps() {
                    const response = await this.fetchAPI('App.List');
                    // sort the apps by sn
                    response.apps.sort((a, b) => a.sn - b.sn);
                    this.appsData = response.apps;
                },

                async consoleLog(tip, msg) {
                    const timestamp = new Date().toLocaleString();
                    this.consoleOutput += dedent`
                        ${timestamp} - ${tip}:
                        ${JSON.stringify(msg, null, 2)}
                    `;
                    this.$nextTick(() => {
                        const consoleElement = document.querySelector('#consoleOutput');
                        consoleElement.scrollTop = consoleElement.scrollHeight;
                    });
                },

                async uploadBlob() {
                    const fileInput = this.$refs.fileInput;
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const data = await this.readFileAsArrayBuffer(file);
                        const blobData = {
                            hash: '0x',
                            hash_algorithm: 'sha256',
                            body: this.toHex(data)
                        };
                        await this.rpcCall('Blobs.Put', blobData);
                        // other logic, if needed...
                    }
                },
                readFileAsArrayBuffer(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            resolve(reader.result);
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                },
                toHex(buffer) {
                    return '0x' + Array.from(new Uint8Array(buffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                },

                async deployApp() {
                    try {
                        const manifest = {
                            runtime: "test", // assuming 'runtime' as a static value for demo purposes
                            code_hash: this.deployForm.codeHash,
                            hash_algorithm: "sha256", // assuming 'hash_algorithm' as static too
                            args: JSON.parse(this.deployForm.args),
                            env_vars: JSON.parse(this.deployForm.envVars),
                            start_mode: this.deployForm.startMode,
                            salt: this.deployForm.salt,
                            resizable: this.deployForm.resizable
                        };
                        await this.rpcCall('App.Deploy', { manifest });
                        this.loadApps();
                    } catch (error) {
                        console.error("Deploy App Error:", error);
                        this.consoleLog("Deploy App Error", error);
                    }
                },
                async stopApp(address) {
                    try {
                        await this.rpcCall('App.Stop', { address: address });
                        this.loadApps();
                    } catch (error) {
                        this.consoleLog('Error stopping app', error);
                    }
                },

                async startApp(address) {
                    try {
                        await this.rpcCall('App.Start', { address: address });
                        this.loadApps();
                    } catch (error) {
                        this.consoleLog('Error starting app', error);
                    }
                },

                async resizeApp(address) {
                    try {
                        let newSize = parseInt(prompt('Enter new size for app:'));
                        await this.rpcCall('App.Resize', { address: address, instances: newSize });
                        this.loadApps();
                    } catch (error) {
                        this.consoleLog('Error resizing app', error);
                    }
                },

                async removeApp(address) {
                    try {
                        await this.rpcCall('App.Remove', { address: address });
                        this.loadApps();
                    } catch (error) {
                        this.consoleLog('Error removing app', error);
                    }
                },

                async clearApps() {
                    await this.rpcCall('App.Clear', {});
                    this.loadApps();
                },

                async copyConsoleOutput() {
                    if (this.consoleOutput) {
                        navigator.clipboard.writeText(this.consoleOutput).then(() => {
                            console.log('Console output copied to the clipboard.');
                        }, (err) => {
                            console.error('Could not copy text: ', err);
                        });
                    }
                },

                async clearConsoleOutput() {
                    this.consoleOutput = '';
                },

                addToast(message) {
                    const id = this.nextToastId++;
                    this.toasts.push({ id, message, type: 'pending', show: true });
                    return id;
                },

                removeToast(id) {
                    const toastIndex = this.toasts.findIndex(toast => toast.id === id);
                    if (toastIndex !== -1) {
                        this.toasts.splice(toastIndex, 1);
                    }
                },

                updateToast(id, success) {
                    const toastIndex = this.toasts.findIndex(toast => toast.id === id);
                    if (toastIndex !== -1) {
                        this.toasts[toastIndex].type = success ? 'success' : 'error';
                        setTimeout(() => this.removeToast(id), success ? 1000 : 5000);
                    }
                },
            },
            mounted() {
                this.updateInfo();
                this.loadApps();
            }
        }).mount("#app");

        function dedent(callSite, ...args) {
            function format(str) {
                let size = -1;
                return str.replace(/\n(\s+)/g, (m, m1) => {
                    if (size < 0)
                        size = m1.replace(/\t/g, "    ").length;
                    return "\n" + m1.slice(Math.min(m1.length, size));
                });
            }
            if (typeof callSite === "string")
                return format(callSite);

            if (typeof callSite === "function")
                return (...args) => format(callSite(...args));

            let output = callSite
                .slice(0, args.length + 1)
                .map((text, i) => (i === 0 ? "" : args[i - 1]) + text)
                .join("");

            return format(output);
        }
    </script>
</body>

</html>